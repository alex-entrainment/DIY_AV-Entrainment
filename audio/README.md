# Audio Generation Details

The `synth_functions/sound_creator.py` script provides the engine for generating audio tracks defined in the GUI. It offers a modular system for combining different synthesis techniques.

## Design

### Framework

The GUI dynamically discovers available synth functions from `sound_creator.SYNTH_FUNCTIONS`. Each function generates a segment of stereo audio based on parameters passed from the GUI (`duration`, `sample_rate`, `params` dictionary).

### Parameter Parsing

Default values for synth functions are automatically parsed from comments within the `sound_creator.py` source code using `inspect` and `ast`, simplifying the addition of new synths.

### Transitions

Most synth functions include a `_transition` variant (e.g., `basic_am_transition`). When selected in the GUI via the "Is Transition?" checkbox, these functions smoothly interpolate key parameters (like frequency, modulation depth, etc.) from a `startValue` to an `endValue` over the duration of the step.

### Track Assembly

The `generate_audio` function orchestrates the process:

  1. Iterates through each step defined in the sequence.
  2. For each step, iterates through all defined voices.
  3. Calls the appropriate synth function (standard or transition) for each voice with its parameters.
  4. Mixes the audio generated by all voices within that step.
  5. Concatenates the audio from each step, applying a phase-aligned crossfade (curve selectable in Preferences, duration set in Global Settings) between steps to ensure smooth, artifact-free transitions.
  6. Applies a safety limiter to the final mixed track.
  7. Normalizes the audio to the **Target Output Amplitude** (0-1.0) specified in Preferences (default `0.25`).
  8. Saves the result as a 16-bit stereo file in the format specified by the output filename (`.wav`, `.flac`, or `.mp3`).

## Functions

Available Synth Functions:

* `binaural_beat`: Generates classic binaural beats by presenting slightly different frequencies to the left and right channels (`baseFreq`, `beatFreq`). Pan is ignored.
* `isochronic_tone`: Pulsing tone with a trapezoidal envelope. Supports the same
  modulation parameters as `binaural_beat` (minus the glitch options) in
  addition to `rampPercent`, `gapPercent`, and optional `pan`.
* `basic_am`: Simple Amplitude Modulation where a carrier sine wave (`carrierFreq`) is modulated by an LFO (`modFreq`, `modDepth`).
* `fsam_filter_bank`: Frequency-Selective Amplitude Modulation. Filters a noise source (white, pink, or brown) into a specific band (`filterCenterFreq`, `filterRQ`) and modulates only that band with an LFO (`modFreq`, `modDepth`), mixing it back with the rest of the noise.
* `rhythmic_waveshaping`: Modulates the amplitude of a carrier (`carrierFreq`) with an LFO (`modFreq`, `modDepth`) before applying tanh waveshaping (`shapeAmount`).
* `additive_phase_mod`: Two sine waves (fundamental `fundFreq`, 2nd harmonic `h2Amp`). The phase of the second harmonic is modulated by an LFO (`modFreq`, `modDepth`).
* `stereo_am_independent`: Independent AM for left/right channels. Uses slightly detuned carriers (`carrierFreq`, `stereo_width_hz`) and independent LFOs (`modFreqL/R`, `modDepthL/R`, `modPhaseL/R`).
* `noise_am`: Modulates a carrier sine wave (`carrierFreq`) using filtered noise (white/pink/brown, low-pass filtered at `modFilterFreq`) as the modulator source (`modDepth`).
* `wave_shape_stereo_am`: Combines rhythmic waveshaping and stereo AM into one complex voice.
* `spatial_angle_modulation` (*Requires external `audio_engine` module*): Uses Spatial Angle Modulation techniques to simulate a moving sound source. Parameters include `pathShape`, `pathRadius`, `arcStartDeg`, `arcEndDeg`.
* `rhythmic_granular_rate`: Currently a placeholder, does not generate sound.

## Core Utilities

`sound_creator.py` also includes essential DSP building blocks:

* Sine wave generation (constant and varying frequency via phase accumulation).
* Noise generation (white, pink via filtering, brown via integration, plus blue, purple, red, deep brown and green variants).
* Butterworth filters (bandpass, band-reject, lowpass).
* Envelope generators (ADSR, Linen, Linear Fade).
* Stereo Panning (`pan2` using equal power law).
* Safety Limiter (hard clipping).

## GUI Overview
![Sequence Editor GUI with Voice Editor Dialog](https://github.com/user-attachments/assets/f39bcc5c-3505-4803-b201-8d2f05d44d3c)

The voice editor dialog includes buttons to **Load Preset** and **Save Preset** so common voice configurations can be reused across projects.

### Step Tester Preview
The editor includes a "Test Step Preview" panel for quickly auditioning a single
step without generating the entire track. When a step is selected, the preview
duration adapts to the step length:

* If the step is shorter than 180&nbsp;seconds, the preview plays the entire
  step.
* For longer steps, a 60&nbsp;second excerpt is generated.

This behaviour ensures that very long steps do not delay the preview yet short
steps can still be heard in full.

### WebAssembly DSP Backend
For browser-based projects you can compile the Rust realtime backend to WebAssembly. See [audio/src/realtime_backend/WASM_GUIDE.md](audio/src/realtime_backend/WASM_GUIDE.md) for build and usage steps.

### CLI Playback
In addition to the Python bindings, the realtime backend provides a small command
line interface. After building the crate with Cargo you can directly play a track
JSON file:

```bash
cargo run -p realtime_backend --bin play_json -- path/to/track.json
```
During playback you can press `p` to toggle pause/resume or `q` to quit. `Ctrl+C` also stops the stream.

### Backend Configuration
The realtime backend reads a `config.toml` file located in
`audio/src/realtime_backend/`. This file allows setting the default output
directory, enabling GPU mixing, and specifying global gain adjustments for
voices, background noise and overlay clips. Example:

```toml
output_dir = "output"
gpu = false
voice_gain = 1.0
noise_gain = 1.0
clip_gain = 1.0
```

Relative path outputs in `render_*` functions or the CLI are written beneath the
configured `output_dir`.

## Editor Features

The **Track Editor** under `audio/src/main.py` exposes a full GUI for arranging
multi-step audio tracks. The main window contains three panels – Steps, Voices
and Overlay Clips – plus a test preview section and several helper tools.

### Steps Panel

- **Add Step** – create a new step at the end of the list.
- **Load External Step** – import a step definition from another JSON file.
- **Duplicate Step** – copy the selected step including all voices.
- **Create End State Step** – insert a new step using the last values of the
  selected one.
- **Remove Step(s)** – delete any highlighted steps.
- **Edit Duration** and **Edit Description** – change the length or description
  of the selected step.
- **Move Up/Move Down** – reorder the step within the sequence.

### Voices Panel

- **Add Voice** – open the Voice Editor dialog to configure a new voice.
- **Edit Voice** – modify parameters of the highlighted voice.
- **Duplicate Voice** – copy the selected voice within the current step.
- **Remove Voice(s)** – delete selected voices from the step.
- **Move Up/Move Down** – change a voice's order (affects mixing priority).

### Overlay Clips

- **Add Clip** – choose an audio file to layer on top of the generated voices.
- **Edit Clip** – adjust start time, amplitude, pan and fades.
- **Remove Clip(s)** – delete selected overlay entries.
- **Start Clip/Stop Clip** – preview a clip without rendering the full track.

### Test Step Preview

The bottom of the Steps panel features a preview player:

- **Play/Pause** – load the currently selected step and start/stop playback.
- **Stop** – halt playback without clearing the loaded audio.
- **Reset Tester** – unload the preview and reset the position slider.
- **Duration** – set the preview length in seconds (0 up to the step's length).
- **Time Slider** – scrub through the generated audio while previewing.

### Tool Buttons

The Controls area exposes additional dialogs:

- **Open Noise Generator** – create swept-notch noise presets or export noise
  files via `NoiseGeneratorDialog`.
- **Frequency Tester** – audition up to ten binaural beat pairs in real time.
- **Add Subliminal Voice** – encode external audio as an ultrasonic subliminal
  and insert it into the selected step.
- **View Timeline** – render an interactive Plotly timeline showing all steps,
  voices and overlay clips.

### Noise Generator Panel

The Noise Generator dialog creates swept-notch noise clips for use as
background audio or as standalone files.  Set the desired **Duration** and
**Sample Rate**, then choose a noise colour (pink or brown).  You can optionally
enable the **Transition** mode to sweep notch parameters over time.

The **LFO Waveform** and **LFO Freq** fields control how quickly the notches
move.  Up to three independent sweeps may be configured, each with start/end
ranges for the notches, filter **Q** and cascade count.  Phase offsets and start
/end offsets let you fine‑tune the timing of the modulation.

Noise settings can be saved or loaded via the **Save** and **Load** buttons.
Press **Test** to preview a short 30&nbsp;s excerpt, or **Generate** to export a
`.wav` file using the current parameters.

Preferences (available from the File menu) store font settings, sample rate,
target output amplitude, amplitude display mode (absolute or dB) and more.
You can also configure default voice parameters that are used when creating new
voices.

